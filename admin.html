<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin | Tango's</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --yellow: #FFB308;
      --dark-yellow: #e09900;
      --gray: #111;
    }
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      background: linear-gradient(45deg,#000,#222);
      color: var(--white);
      font-family:'Inter',sans-serif;
      text-align:center;
      min-height:100vh;
    }
    .container {
      max-width:600px;
      margin:0 auto;
      padding:2rem 1rem;
    }
    .logo {
      width:120px;
      margin:0 auto 1.5rem;
      display:block;
      filter:drop-shadow(0 0 10px rgba(255,179,8,0.5));
      animation:pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.05)}
    }
    h1 {
      color: var(--yellow);
      font-size:2rem;
      font-weight:900;
      margin-bottom:2rem;
      text-transform:uppercase;
      letter-spacing:2px;
      text-shadow:0 0 8px rgba(255,179,8,0.7);
    }
    input,textarea,button,select {
      width:90%; max-width:350px;
      padding:1rem; margin:0.75rem auto;
      font-size:1rem; border:none; border-radius:8px;
      transition:all .3s ease;
    }
    input,textarea,select {
      background:#222; color:#fff; border:2px solid var(--yellow);
    }
    input:focus,textarea:focus,select:focus {
      outline:none; box-shadow:0 0 12px rgba(255,179,8,0.5);
      transform:translateY(-2px);
    }
    button {
      background: var(--yellow);
      color: var(--black);
      font-weight:900;
      cursor:pointer;
      text-transform:uppercase;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      position:relative; overflow:hidden;
    }
    button:hover {
      background: var(--dark-yellow);
      transform:translateY(-3px);
      box-shadow:0 6px 18px rgba(0,0,0,0.4);
    }
    button::after {
      content:'';
      position:absolute; top:0; left:-100%;
      width:100%; height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
      transition:0.5s;
    }
    button:hover::after { left:100%; }
    .btn-group {
      display:flex; flex-direction:column; gap:1rem; margin:2rem 0;
    }
    .btn-group button { height:50px; }
    .section {
      display:none;
      background: rgba(17,17,17,0.8);
      padding:1.5rem 1rem;
      margin-top:1.5rem;
      border-radius:12px;
      border:2px solid var(--yellow);
      backdrop-filter:blur(8px);
    }
    .section.active { display:block; animation:fadeIn .4s ease-out; }
    @keyframes fadeIn {
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .producto-item {
      background:#222;
      margin:0.5rem auto;
      padding:0.75rem;
      border-radius:8px;
      max-width:90%;
      cursor:pointer;
      text-align:left;
      border-left:4px solid var(--yellow);
      transition:all .3s;
    }
    .producto-item:hover {
      background:#333; transform:translateX(4px);
    }
    .status {
      font-weight:600;color:var(--yellow);
      margin-top:0.5rem;
    }
    .salir-btn {
      background:#333;color:#fff;border:2px solid var(--yellow);
      margin-top:2rem;
    }
    .salir-btn:hover { background:#444; }
    /* REPORTES */
    .controls { margin:1rem auto; max-width:400px; }
    .controls select, .controls button { margin:0.5rem 0; }
    #chart { max-width:100%; margin:1rem auto; }
    .sugerencias { text-align:left; max-height:150px; overflow:auto; background:#222;
      padding:0.75rem; border-radius:8px; border:1px solid var(--yellow);
      margin-top:1rem; }
  </style>
</head>
<body>

  <div class="container">
    <img src="assets/images/logo3.png" alt="Logo" class="logo">

    <div id="auth">
      <h1>Administrador</h1>
      <input type="password" id="clave" placeholder="Contrase√±a de acceso" autocomplete="off" inputmode="numeric" />
      <button id="btnAcceder">Entrar</button>
      <p id="statusGlobal" class="status"></p>
    </div>

    <div id="panel" style="display:none;">
      <h1>Gesti√≥n de productos</h1>
      <div class="btn-group">
        <button onclick="mostrar('a√±adir')">‚ûï A√±adir producto</button>
        <button onclick="mostrar('eliminar')">üóëÔ∏è Eliminar producto</button>
        <button onclick="mostrar('reportes')">üìä Ver reportes</button>
      </div>
      <p id="statusGlobal2" class="status"></p>

      <!-- A√ëADIR -->
      <div id="a√±adir" class="section">
        <form id="formNuevo">
          <input type="text" id="nombre" placeholder="Nombre" required />
          <textarea id="descripcion" placeholder="Descripci√≥n" required></textarea>
          <input type="number" id="precio" placeholder="Precio" required />
          <input type="file" id="imagen" accept="image/*" required />
          <button type="submit">Guardar producto</button>
          <p id="statusAdd" class="status"></p>
        </form>
      </div>

      <!-- ELIMINAR -->
      <div id="eliminar" class="section">
        <div id="listaEliminar"></div>
      </div>

      <!-- REPORTES -->
      <div id="reportes" class="section">
        <h2 style="color:var(--yellow)">Reportes de Encuesta</h2>
        <div class="controls">
          <label style="display:block;text-align:left;font-weight:600;">Ver gr√°fica:</label>
          <select id="tipoReporte">
            <option value="seccion">Por Secci√≥n (Promedios)</option>
            <option value="pregunta">Por Pregunta (Distribuci√≥n)</option>
          </select>
          <div id="preguntaSelector" style="display:none;">
            <select id="seccionSel">
              <option value="sabor">Secci√≥n: Sabor</option>
              <option value="local">Secci√≥n: Local</option>
              <option value="atencion">Secci√≥n: Atenci√≥n</option>
            </select>
            <select id="numPregunta">
              <option value="1">Pregunta 1</option>
              <option value="2">Pregunta 2</option>
              <option value="3">Pregunta 3</option>
              <option value="4">Pregunta 4</option>
              <option value="5">Pregunta 5</option>
            </select>
          </div>
          <button id="btnGenerar">Generar Gr√°fica</button>
        </div>
        <canvas id="chart" width="400" height="240"></canvas>
        <h3 style="color:var(--yellow); text-align:left; margin-top:1.5rem;">Sugerencias / Comentarios:</h3>
        <div id="sugerencias" class="sugerencias"></div>
      </div>

      <button onclick="window.location.href='index.html'" class="salir-btn">üö™ Salir del modo admin</button>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'
    const supabase = createClient(
      'https://ljlaudvreolkdppgfqul.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpZV‚Ä¶' // tu llave aqu√≠
    );

    const statusGlobal = document.getElementById("statusGlobal");
    document.getElementById('btnAcceder').onclick = () => {
      if (document.getElementById("clave").value === "240624") {
        document.getElementById("auth").style.display = "none";
        document.getElementById("panel").style.display = "block";
        cargarProductos();
        cargarSugerencias();
      } else {
        statusGlobal.textContent = "‚ùå Contrase√±a incorrecta";
      }
    };

    // Muestra secci√≥n
    window.mostrar = id => {
      document.querySelectorAll(".section").forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.getElementById("statusGlobal2").textContent = "";
      if (id==='reportes') prepararReportes();
    };

    // Agregar
    document.getElementById("formNuevo").onsubmit = async e => {
      e.preventDefault();
      const n = document.getElementById("nombre").value;
      const d = document.getElementById("descripcion").value;
      const p = parseFloat(document.getElementById("precio").value);
      const f = document.getElementById("imagen").files[0];
      const nombreArchivo = `${Date.now()}-${f.name}`;
      const { error:errU } = await supabase.storage.from('productos').upload(nombreArchivo,f);
      if (errU) return document.getElementById("statusAdd").textContent = "‚ùå Error subir imagen";
      const { data } = supabase.storage.from('productos').getPublicUrl(nombreArchivo);
      const { error:errI } = await supabase.from("productos").insert([{ nombre:n,descripcion:d,precio:p,imagen_url:data.publicUrl }]);
      document.getElementById("statusAdd").textContent = errI ? "‚ùå Error al guardar" : "‚úÖ Guardado";
      e.target.reset(); cargarProductos();
    };

    // Eliminar
    async function cargarProductos(){
      const { data:prods } = await supabase.from("productos").select('*').order('created_at',{ascending:false});
      const cont = document.getElementById("listaEliminar");
      cont.innerHTML = '';
      prods.forEach(p=>{
        const div = document.createElement('div');
        div.className='producto-item';
        div.textContent=p.nombre;
        div.onclick=async()=>{
          if (confirm(`Eliminar "${p.nombre}"?`)){
            await supabase.from("productos").delete().eq('id',p.id);
            cargarProductos();
          }
        };
        cont.append(div);
      });
    }

    // REPORTES:
    let chart;
    function prepararReportes(){
      // reset
      document.getElementById('preguntaSelector').style.display='none';
      document.getElementById('tipoReporte').value='seccion';
      if (chart) chart.destroy();
    }

    document.getElementById('tipoReporte').onchange = e => {
      document.getElementById('preguntaSelector').style.display =
        e.target.value==='pregunta' ? 'block' : 'none';
    };

    document.getElementById('btnGenerar').onclick = async ()=>{
      const tipo = document.getElementById('tipoReporte').value;
      const enc = await supabase.from('encuesta').select('*');
      if (enc.error) return;
      const rows = enc.data;

      if (chart) chart.destroy();
      const ctx = document.getElementById('chart').getContext('2d');

      if (tipo==='seccion'){
        // Promedio por secci√≥n
        const secs = ['sabor','local','atencion'];
        const proms = secs.map(sec=>{
          let sum=0,c=0;
          rows.forEach(r=>{
            for(let i=1;i<=5;i++){
              sum += r[`${sec}_${i}`];
              c++;
            }
          });
          return (sum/c).toFixed(2);
        });
        chart = new Chart(ctx,{type:'bar',
          data:{labels:['Sabor','Local','Atenci√≥n'],datasets:[{
            label:'Promedio',data:proms,backgroundColor:'rgba(255,179,8,0.7)'
          }]},
          options:{scales:{y:{beginAtZero:true,max:5}}}
        });

      } else {
        // Distribuci√≥n por pregunta
        const sec = document.getElementById('seccionSel').value;
        const num = document.getElementById('numPregunta').value;
        const key = `${sec}_${num}`;
        const counts = [0,0,0,0,0];
        rows.forEach(r=>{ 
          const v = r[key];
          if (v>=1&&v<=5) counts[v-1]++; 
        });
        chart = new Chart(ctx,{type:'bar',
          data:{labels:['1','2','3','4','5'],datasets:[{
            label:`Distribuci√≥n ${sec} P${num}`,data:counts,backgroundColor:'rgba(255,179,8,0.7)'
          }]},
          options:{scales:{y:{beginAtZero:true}}}
        });
      }
    };

    // Cargar sugerencias
    async function cargarSugerencias(){
      const { data } = await supabase.from('encuesta').select('sugerencias');
      const cont = document.getElementById('sugerencias');
      cont.innerHTML = '';
      data.filter(r=>r.sugerencias).forEach(r=>{
        const p = document.createElement('p');
        p.textContent = '‚Ä¢ ' + r.sugerencias;
        cont.append(p);
      });
    }
  </script>
</body>
</html>
