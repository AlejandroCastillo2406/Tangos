<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin | Tango's</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --yellow: #ffd700;
      --gray: #111;
    }

    body {
      background: var(--black);
      color: var(--white);
      font-family: 'Inter', sans-serif;
      text-align: center;
      padding: 2rem 1rem;
    }

    .logo {
      max-width: 100px;
      margin: 0 auto 1rem;
    }

    h1 {
      font-size: 2rem;
      font-weight: 900;
      color: var(--yellow);
      margin-bottom: 2rem;
    }

    .btn-group button {
      background: var(--yellow);
      color: var(--black);
      font-weight: 800;
      padding: 1rem;
      margin: 0.5rem;
      width: 90%;
      max-width: 300px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn-group button:hover {
      background: #ffe66a;
    }

    .section {
      display: none;
      margin-top: 2rem;
      background: var(--gray);
      padding: 1.5rem;
      border-radius: 12px;
    }

    .section.active {
      display: block;
    }

    input, textarea, select {
      display: block;
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #222;
      color: #fff;
    }

    .producto-item {
      background: #222;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .producto-item:hover {
      background: #333;
    }

    .status {
      margin-top: 1rem;
      font-size: 0.9rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="auth">
    <h1>Administrador</h1>
    <input type="password" id="clave" placeholder="Contrase√±a de acceso" />
    <button onclick="validarClave()">Entrar</button>
  </div>

  <div id="admin" style="display:none;">
    <img src="assets/images/logo1.png" class="logo" alt="Logo">
    <h1>Gesti√≥n de productos</h1>

    <div class="btn-group">
      <button onclick="mostrar('a√±adir')">‚ûï A√±adir nuevo producto</button>
      <button onclick="mostrar('actualizar')">‚úèÔ∏è Actualizar producto</button>
      <button onclick="mostrar('eliminar')">üóëÔ∏è Eliminar producto</button>
    </div>

    <h2 style="margin-top:3rem; font-weight:900;">Reportes</h2>

    <div id="a√±adir" class="section">
      <form id="formNuevo">
        <input type="text" id="nombre" placeholder="Nombre" required />
        <textarea id="descripcion" placeholder="Descripci√≥n" required></textarea>
        <input type="number" id="precio" placeholder="Precio" required />
        <input type="file" id="imagen" accept="image/*" required />
        <button type="submit">Guardar producto</button>
        <p id="status" class="status"></p>
      </form>
    </div>

    <div id="actualizar" class="section">
      <div id="listaActualizar"></div>
    </div>

    <div id="eliminar" class="section">
      <div id="listaEliminar"></div>
    </div>
  </div>
    <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://ljlaudvreolkdppgfqul.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqbGF1ZHZyZW9sa2RwcGdmcXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzEzOTYsImV4cCI6MjA2MDYwNzM5Nn0.tv5PybOJ0ZUtA2aw2WzPqQ9M7SZm3uke6Ad-OuxZbzk';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const status = document.getElementById("status");

    function validarClave() {
      const clave = document.getElementById("clave").value;
      if (clave === "240624") {
        document.getElementById("auth").style.display = "none";
        document.getElementById("admin").style.display = "block";
        cargarProductos();
      } else {
        alert("Contrase√±a incorrecta");
      }
    }

    function mostrar(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    document.getElementById("formNuevo").addEventListener("submit", async (e) => {
      e.preventDefault();

      const nombre = document.getElementById("nombre").value;
      const descripcion = document.getElementById("descripcion").value;
      const precio = parseFloat(document.getElementById("precio").value);
      const archivo = document.getElementById("imagen").files[0];

      const nombreArchivo = `${Date.now()}-${archivo.name}`;
      const { error: errorUpload } = await supabase.storage
        .from('productos')
        .upload(nombreArchivo, archivo);

      if (errorUpload) {
        status.textContent = "‚ùå Error al subir imagen";
        return;
      }

      const { data: urlData } = supabase.storage.from('productos').getPublicUrl(nombreArchivo);
      const imagen_url = urlData.publicUrl;

      const { error: errorInsert } = await supabase
        .from("productos")
        .insert([{ nombre, descripcion, precio, imagen_url }]);

      if (errorInsert) {
        status.textContent = "‚ùå Error al guardar";
      } else {
        status.textContent = "‚úÖ Producto guardado";
        e.target.reset();
        cargarProductos();
      }
    });

    async function cargarProductos() {
      const { data: productos, error } = await supabase
        .from("productos")
        .select("*")
        .order("created_at", { ascending: false });

      const listaActualizar = document.getElementById("listaActualizar");
      const listaEliminar = document.getElementById("listaEliminar");
      listaActualizar.innerHTML = "";
      listaEliminar.innerHTML = "";

      productos.forEach(p => {
        // Para eliminar
        const divE = document.createElement("div");
        divE.classList.add("producto-item");
        divE.textContent = p.nombre;
        divE.onclick = () => {
          if (confirm(`¬øEliminar "${p.nombre}"?`)) {
            supabase.from("productos").delete().eq("id", p.id).then(() => {
              alert("‚úÖ Eliminado");
              cargarProductos();
            });
          }
        };
        listaEliminar.appendChild(divE);

        // Para actualizar
        const divA = document.createElement("div");
        divA.classList.add("producto-item");
        divA.textContent = p.nombre;
        divA.onclick = () => {
          const nuevo = prompt(`Editar producto "${p.nombre}" (nombre|precio|descripcion):`, `${p.nombre}|${p.precio}|${p.descripcion}`);
          if (nuevo) {
            const [nombre, precio, descripcion] = nuevo.split("|");
            const imagenInput = document.createElement("input");
            imagenInput.type = "file";
            imagenInput.accept = "image/*";
            imagenInput.onchange = async () => {
              let imagen_url = p.imagen_url;
              if (imagenInput.files.length > 0) {
                const archivo = imagenInput.files[0];
                const nombreArchivo = `${Date.now()}-${archivo.name}`;
                await supabase.storage.from('productos').upload(nombreArchivo, archivo);
                const { data: urlData } = supabase.storage.from('productos').getPublicUrl(nombreArchivo);
                imagen_url = urlData.publicUrl;
              }

              const { error } = await supabase.from("productos")
                .update({ nombre, precio, descripcion, imagen_url })
                .eq("id", p.id);
              if (!error) {
                alert("‚úÖ Actualizado");
                cargarProductos();
              } else {
                alert("‚ùå Error al actualizar");
              }
            };
            imagenInput.click(); // Simula click para cambiar imagen (opcional)
          }
        };
        listaActualizar.appendChild(divA);
      });
    }
  </script>

</body>
</html>

