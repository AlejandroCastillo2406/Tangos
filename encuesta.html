<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Encuesta | Tango's</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --yellow: #FFB308;
      --gray: #111;
      --gray-light: #222;
    }
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family:'Inter',sans-serif;
      background: var(--black);
      color: var(--white);
      display:flex; flex-direction:column;
      min-height:100vh;
    }
    header {
      background: var(--black);
      border-bottom:3px solid var(--yellow);
      padding:1rem; text-align:center;
    }
    header h1 {
      color: var(--yellow); font-weight:900; font-size:1.8rem;
    }
    main {
      flex:1; padding:1rem;
      max-width:480px; margin:0 auto;
    }
    .step {
      display:none; animation:fadeIn .4s ease-out;
    }
    .step.active { display:block }
    @keyframes fadeIn {
      from {opacity:0;transform:translateY(10px)}
      to   {opacity:1;transform:translateY(0)}
    }
    .step h2 {
      color: var(--yellow);
      margin-bottom:1rem;
      text-transform:uppercase;
      font-weight:600;
      text-align:center;
    }
    .question {
      margin:1rem 0 .5rem;
      font-size:1rem;
    }
    .rating {
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:.5rem;
      margin-bottom:1rem;
    }
    .rating input { display:none }
    .rating label {
      width:40px; height:40px;
      border:2px solid var(--yellow);
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; color:var(--white);
      transition:background .2s,color .2s;
    }
    .rating input:checked + label {
      background: var(--yellow);
      color: var(--black);
    }
    textarea {
      width:100%;
      min-height:100px;
      background: var(--gray-light);
      color:var(--white);
      border:2px solid var(--yellow);
      border-radius:8px;
      padding:.5rem;
      resize:none;
      margin-bottom:1rem;
    }
    .buttons {
      display:flex; gap:1rem;
    }
    .buttons button {
      flex:1;
      background: var(--yellow);
      color: var(--black);
      border:none;
      padding:.75rem;
      font-weight:600;
      cursor:pointer;
      border-radius:8px;
      transition:transform .2s;
    }
    .buttons button:disabled {
      background:#444;
      cursor:not-allowed;
    }
    .buttons button:hover:not(:disabled) {
      transform:translateY(-2px);
    }
    .message {
      margin-top:1rem;
      text-align:center;
      font-weight:600;
    }
    footer {
      background: var(--gray);
      text-align:center;
      padding:1rem;
      font-size:.8rem;
      color:#aaa;
    }
  </style>
</head>
<body>

<header>
  <h1>Encuesta Tango's</h1>
</header>

<main>
  <!-- Paso 1: Sabor -->
  <div class="step active" data-step="1">
    <h2>Sección 1: Sabor</h2>
    <!-- Cinco preguntas -->
    <script>
      const preguntasSabor = [
        '¿Qué tan intenso te pareció el sabor?',
        '¿Lo encontraste equilibrado?',
        '¿Fue memorable?',
        '¿La presentación ayudó al sabor?',
        '¿Lo recomendarías?'
      ];
    </script>
    <div id="contenedor-sabor"></div>
    <div class="buttons">
      <button id="next1" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Paso 2: Local -->
  <div class="step" data-step="2">
    <h2>Sección 2: Local</h2>
    <script>
      const preguntasLocal = [
        '¿El ambiente te gustó?',
        '¿El nivel de limpieza fue adecuado?',
        '¿La decoración te pareció atractiva?',
        '¿Te sentiste cómodo en el local?',
        '¿El espacio fue suficiente para ti?'
      ];
    </script>
    <div id="contenedor-local"></div>
    <div class="buttons">
      <button id="prev2">Anterior</button>
      <button id="next2" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Paso 3: Atención -->
  <div class="step" data-step="3">
    <h2>Sección 3: Atención</h2>
    <script>
      const preguntasAtencion = [
        '¿Fueron amables?',
        '¿Fueron rápidos?',
        '¿Fueron profesionales?',
        '¿Te dieron recomendaciones útiles?',
        '¿Volverías por su atención?'
      ];
    </script>
    <div id="contenedor-atencion"></div>
    <div class="buttons">
      <button id="prev3">Anterior</button>
      <button id="next3" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Paso 4: Sugerencias -->
  <div class="step" data-step="4">
    <h2>Sección 4: Sugerencias</h2>
    <textarea id="sugerencias" placeholder="Tu comentario (opcional)"></textarea>
    <div class="buttons">
      <button id="prev4">Anterior</button>
      <button id="submit">Enviar</button>
    </div>
    <p id="message" class="message"></p>
  </div>
</main>

<footer>&copy; 2025 Tango's. ¡Gracias por tu feedback!</footer>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js'
  const supabase = createClient(
    'https://ljlaudvreolkdppgfqul.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqbGF1ZHZyZW9sa2RwcGdmcXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzEzOTYsImV4cCI6MjA2MDYwNzM5Nn0.tv5PybOJ0ZUtA2aw2WzPqQ9M7SZm3uke6Ad-OuxZbzk'
  );

  // Genera dinámicamente las preguntas
  function construirSeccion(contenedorId, preguntas, clave) {
    const cont = document.getElementById(contenedorId);
    preguntas.forEach((texto, i) => {
      const idx = i+1;
      const divQ = document.createElement('div');
      divQ.className = 'question';
      divQ.textContent = `${idx}. ${texto}`;
      cont.appendChild(divQ);

      const rating = document.createElement('div');
      rating.className = 'rating';
      rating.dataset.key = `${clave}_${idx}`;
      for (let v=1;v<=5;v++){
        const inp = document.createElement('input');
        inp.type='radio'; inp.id=`${clave}_${idx}_${v}`;
        inp.name=`${clave}${idx}`; inp.value=v;
        const lbl = document.createElement('label');
        lbl.setAttribute('for', inp.id);
        lbl.textContent = v;
        rating.appendChild(inp); rating.appendChild(lbl);
      }
      cont.appendChild(rating);
    });
  }
  construirSeccion('contenedor-sabor', preguntasSabor, 'sabor');
  construirSeccion('contenedor-local', preguntasLocal, 'local');
  construirSeccion('contenedor-atencion', preguntasAtencion, 'atencion');

  const steps = Array.from(document.querySelectorAll('.step'));
  let current = 0;
  const answers = {};

  // Genera/stores device_id
  const deviceKey = 'encuestaDevice';
  let deviceId = localStorage.getItem(deviceKey);
  if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem(deviceKey, deviceId);
  }
  // Prevenir doble envío
  (async()=>{
    const { data } = await supabase
      .from('encuesta')
      .select('id')
      .eq('device_id', deviceId);
    if (data.length){
      document.body.innerHTML = `
        <header><h1>Encuesta Tango's</h1></header>
        <main><p class="message">Ya respondieron desde este dispositivo. ¡Gracias!</p></main>
        <footer>&copy;2025 Tango's</footer>`;
    }
  })();

  function show(i){
    steps[current].classList.remove('active');
    current=i;
    steps[current].classList.add('active');
  }

  // Wire Next/Prev
  document.getElementById('next1').onclick = ()=> show(1);
  document.getElementById('prev2').onclick = ()=> show(0);
  document.getElementById('next2').onclick = ()=> show(2);
  document.getElementById('prev3').onclick = ()=> show(1);
  document.getElementById('next3').onclick = ()=> show(3);
  document.getElementById('prev4').onclick = ()=> show(2);

  // Habilitar “Siguiente” sólo si cada .rating tiene un checked
  steps.slice(0,3).forEach((step, idx)=>{
    const btnId = ['next1','next2','next3'][idx];
    step.querySelectorAll('.rating input').forEach(radio=>{
      radio.addEventListener('change', ()=>{
        const allAnswered = Array.from(step.querySelectorAll('.rating'))
          .every(container => container.querySelector('input:checked'));
        document.getElementById(btnId).disabled = !allAnswered;
      });
    });
  });

  // Envío final
  document.getElementById('submit').onclick = async ()=>{
    answers.device_id = deviceId;
    ['sabor','local','atencion'].forEach(sec=>{
      for(let i=1;i<=5;i++){
        answers[`${sec}_${i}`] =
          parseInt(document.querySelector(`input[name=${sec}${i}]:checked`).value);
      }
    });
    answers.sugerencias = document.getElementById('sugerencias').value || null;

    const { error } = await supabase
      .from('encuesta')
      .insert([answers]);

    const msg = document.getElementById('message');
    if (error) {
      msg.textContent = '❌ Error: ' + error.message;
    } else {
      msg.textContent = '✅ Encuesta enviada. ¡Gracias!';
      document.getElementById('submit').disabled = true;
    }
  };
</script>

</body>
</html>
