<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Encuesta | Tango’s</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --yellow: #FFB308;
      --gray-dark: #111;
      --gray-light: #222;
      --accent: #FFD56B;
    }
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family:'Inter',sans-serif;
      background: var(--black);
      color: var(--white);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }
    header {
      background: var(--gray-dark);
      padding:1rem;
      text-align:center;
      border-bottom:3px solid var(--yellow);
    }
    header h1 {
      color: var(--yellow);
      font-weight:900;
      font-size:1.75rem;
    }

    main {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }
    .escenario {
      max-width:400px;
      width:100%;
      background: var(--gray-light);
      padding:2rem;
      border-radius:12px;
      box-shadow:0 0 20px rgba(0,0,0,0.7);
      display:none;
    }
    .escenario.active { display:block; animation:fadeIn 0.4s ease }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(20px) }
      to { opacity:1; transform:translateY(0) }
    }

    .titulo-seccion {
      font-size:1.25rem;
      font-weight:600;
      margin-bottom:1rem;
      color: var(--yellow);
      text-align:center;
    }
    .pregunta {
      margin:1rem 0 0.5rem;
      font-size:1rem;
    }
    .respuestas {
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:0.5rem;
      justify-items:center;
    }
    .respuestas label {
      cursor:pointer;
    }
    .respuestas input {
      display:none;
    }
    .respuestas .circle {
      width:40px; height:40px;
      border-radius:50%;
      background: var(--gray-dark);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--white);
      font-weight:600;
      transition:background 0.2s, transform 0.2s;
    }
    .respuestas input:checked + .circle {
      background: var(--yellow);
      color: var(--black);
      transform: scale(1.1);
    }

    .btn-group {
      display:flex;
      justify-content: space-between;
      margin-top:2rem;
    }
    .btn {
      padding:0.75rem 1.5rem;
      background: var(--yellow);
      color: var(--black);
      border:none;
      border-radius:50px;
      font-weight:600;
      cursor:pointer;
      transition:transform 0.2s;
    }
    .btn:disabled {
      opacity:0.5; cursor:not-allowed;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
    }

    textarea {
      width:100%;
      height:80px;
      padding:0.75rem;
      border:none;
      border-radius:8px;
      background: var(--gray-dark);
      color: var(--white);
      resize:none;
    }

    .loader, .mensaje {
      text-align:center;
      margin-top:1rem;
      color:var(--accent);
    }

    footer {
      background: var(--gray-dark);
      padding:1rem;
      text-align:center;
      font-size:0.85rem;
      color:#888;
    }
  </style>
</head>
<body>

<header><h1>Encuesta Tango’s</h1></header>

<main>
  <!-- Local -->
  <div class="escenario" id="esc-local">
    <div class="titulo-seccion">Sección: Local</div>
    <div id="preg-local"></div>
    <div class="btn-group">
      <button class="btn" id="btn-local-next" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Sabor -->
  <div class="escenario" id="esc-sabor">
    <div class="titulo-seccion">Sección: Sabor</div>
    <div id="preg-sabor"></div>
    <div class="btn-group">
      <button class="btn" id="btn-sabor-back">Anterior</button>
      <button class="btn" id="btn-sabor-next" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Atención -->
  <div class="escenario" id="esc-atencion">
    <div class="titulo-seccion">Sección: Atención</div>
    <div id="preg-atencion"></div>
    <div class="btn-group">
      <button class="btn" id="btn-atn-back">Anterior</button>
      <button class="btn" id="btn-atn-next" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Sugerencias -->
  <div class="escenario" id="esc-suger">
    <div class="titulo-seccion">Sugerencias (opcional)</div>
    <textarea id="input-suger" placeholder="¿Algo que quieras comentarnos?"></textarea>
    <div class="btn-group">
      <button class="btn" id="btn-suger-back">Anterior</button>
      <button class="btn" id="btn-submit">Enviar</button>
    </div>
    <div id="mensaje" class="mensaje"></div>
  </div>
</main>

<footer>&copy; 2025 Tango’s. ¡Gracias por tu tiempo!</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

const supabaseUrl = 'https://ljlaudvreolkdppgfqul.supabase.co'
const supabaseKey = 'TU_ANON_KEY_AQUÍ'
const supabase = createClient(supabaseUrl, supabaseKey)

// Preguntas por sección
const preguntas = {
  local: [
    '¿Cómo calificas la limpieza?',
    '¿Cómo está la iluminación?',
    '¿Cómo te pareció la música/ambiente?',
    '¿Qué tal la comodidad del lugar?',
    '¿El precio vs experiencia?'
  ],
  sabor: [
    '¿El sabor es consistente?',
    '¿La presentación te agradó?',
    '¿La variedad de menú es suficiente?',
    '¿La temperatura de la bebida fue adecuada?',
    '¿El nivel de dulzura/sal equilibrado?'
  ],
  atencion: [
    '¿La atención fue amable?',
    '¿El tiempo de espera fue razonable?',
    '¿Te explicaron bien el menú?',
    '¿El personal fue proactivo?',
    '¿Recomendarías el servicio?'
  ]
}

// Generar o recuperar device_id
let deviceId = localStorage.getItem('enc_device')
if (!deviceId) {
  deviceId = crypto.randomUUID()
  localStorage.setItem('enc_device', deviceId)
}

// Comprueba si ya respondió
(async()=>{
  const { data } = await supabase
    .from('encuesta')
    .select('id')
    .eq('device_id', deviceId)
  if (data.length) {
    document.body.innerHTML = `
      <header><h1>Encuesta Tango’s</h1></header>
      <main><p class="loader">Ya respondiste esta encuesta. ¡Gracias!</p></main>
      <footer>&copy; 2025 Tango’s</footer>`
  } else {
    initEncuesta()
  }
})()

function initEncuesta(){
  // Rendiriza preguntas
  ['local','sabor','atencion'].forEach(sec=>{
    const cont = document.getElementById(`preg-${sec}`)
    preguntas[sec].forEach((txt,i)=>{
      const num = i+1
      const div = document.createElement('div')
      div.className = 'pregunta'
      div.textContent = `${num}. ${txt}`
      cont.appendChild(div)
      const respuestas = document.createElement('div')
      respuestas.className = 'respuestas'
      for(let v=1; v<=5; v++){
        const id = `${sec}_${num}_${v}`
        respuestas.innerHTML += `
          <label for="${id}">
            <input type="radio" name="${sec}_${num}" id="${id}" value="${v}">
            <div class="circle">${v}</div>
          </label>`
      }
      cont.appendChild(respuestas)
    })
  })

  // Navegación
  const show = id=> {
    document.querySelectorAll('.escenario').forEach(e=>e.classList.remove('active'))
    document.getElementById(id).classList.add('active')
  }
  show('esc-local')

  // Habilitar botones al seleccionar
  document.querySelectorAll('.respuestas input').forEach(r=>{
    r.addEventListener('change',()=>{
      const [sec] = r.name.split('_')
      const btn = document.getElementById(`btn-${sec}-next`)
      const todos = preguntas[sec].length
      // comprueba que todas del sec tengan respuesta
      let ok=true
      for(let i=1;i<=todos;i++){
        if(!document.querySelector(`[name="${sec}_${i}"]:checked`)){
          ok=false; break
        }
      }
      btn.disabled = !ok
    })
  })

  // Botones
  document.getElementById('btn-local-next').onclick = ()=> show('esc-sabor')
  document.getElementById('btn-sabor-back').onclick = ()=> show('esc-local')
  document.getElementById('btn-sabor-next').onclick = ()=> show('esc-atencion')
  document.getElementById('btn-atn-back').onclick = ()=> show('esc-sabor')
  document.getElementById('btn-atn-next').onclick = ()=> show('esc-suger')
  document.getElementById('btn-suger-back').onclick = ()=> show('esc-atencion')

  document.getElementById('btn-submit').onclick = enviarEncuesta
}

async function enviarEncuesta(){
  // recolecta valores
  const row = { device_id: deviceId }
  for(const sec of ['local','sabor','atencion']){
    preguntas[sec].forEach((_,i)=>{
      const val = parseInt(document.querySelector(`[name="${sec}_${i+1}"]:checked`).value)
      row[`${sec}_${i+1}`] = val
    })
  }
  row.sugerencias = document.getElementById('input-suger').value || null

  // insertar
  const { error } = await supabase.from('encuesta').insert(row)
  const msg = document.getElementById('mensaje')
  if (error) {
    msg.textContent = '❌ Error al enviar, intenta de nuevo'
  } else {
    msg.textContent = '✅ ¡Encuesta enviada, mil gracias!'
    document.getElementById('btn-submit').disabled = true
  }
}
</script>

