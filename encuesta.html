<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Encuesta | Tango's</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --yellow: #FFB308;
      --gray: #111;
      --gray-light: #222;
    }
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family:'Inter',sans-serif;
      background: var(--black);
      color: var(--white);
      display:flex; flex-direction:column;
      min-height:100vh;
    }
    header {
      background: var(--black);
      border-bottom:3px solid var(--yellow);
      padding:1rem; text-align:center;
    }
    header h1 {
      color: var(--yellow); font-weight:900; font-size:1.8rem;
    }
    main {
      flex:1; padding:1rem;
      max-width:480px; margin:0 auto;
    }
    .step {
      display:none; animation:fadeIn .4s ease-out;
    }
    .step.active { display:block }
    @keyframes fadeIn {
      from {opacity:0;transform:translateY(10px)}
      to   {opacity:1;transform:translateY(0)}
    }
    .step h2 {
      color: var(--yellow);
      margin-bottom:1rem;
      text-transform:uppercase;
      font-weight:600;
      text-align:center;
    }
    .question {
      margin:1rem 0 .5rem;
      font-size:1rem;
    }
    .rating {
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:.5rem;
      margin-bottom:1rem;
    }
    .rating input { display:none }
    .rating label {
      width:40px; height:40px;
      border:2px solid var(--yellow);
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; color:var(--white);
      transition:background .2s,color .2s;
    }
    .rating input:checked + label {
      background: var(--yellow);
      color: var(--black);
    }
    textarea {
      width:100%;
      min-height:100px;
      background: var(--gray-light);
      color:var(--white);
      border:2px solid var(--yellow);
      border-radius:8px;
      padding:.5rem;
      resize:none;
      margin-bottom:1rem;
    }
    .buttons {
      display:flex; gap:1rem;
    }
    .buttons button {
      flex:1;
      background: var(--yellow);
      color: var(--black);
      border:none;
      padding:.75rem;
      font-weight:600;
      cursor:pointer;
      border-radius:8px;
      transition:transform .2s;
    }
    .buttons button:disabled {
      background:#444;
      cursor:not-allowed;
    }
    .buttons button:hover:not(:disabled) {
      transform:translateY(-2px);
    }
    .message {
      margin-top:1rem;
      text-align:center;
      font-weight:600;
    }
    footer {
      background: var(--gray);
      text-align:center;
      padding:1rem;
      font-size:.8rem;
      color:#aaa;
    }
  </style>
</head>
<body>

<header>
  <h1>Encuesta Tango's</h1>
</header>

<main>
  <!-- Paso 1: Sabor -->
  <div class="step active" data-step="1">
    <h2>Sección 1: Sabor</h2>
    <div class="question">1. ¿Qué tan intenso te pareció el sabor?</div>
    <div class="rating" data-key="sabor_1">
      <input type="radio" id="sabor_1_1" name="sabor1" value="1"><label for="sabor_1_1">1</label>
      <input type="radio" id="sabor_1_2" name="sabor1" value="2"><label for="sabor_1_2">2</label>
      <input type="radio" id="sabor_1_3" name="sabor1" value="3"><label for="sabor_1_3">3</label>
      <input type="radio" id="sabor_1_4" name="sabor1" value="4"><label for="sabor_1_4">4</label>
      <input type="radio" id="sabor_1_5" name="sabor1" value="5"><label for="sabor_1_5">5</label>
    </div>
    <!-- Repite 4 preguntas más cambiando índice -->
    <div class="question">2. ¿Lo encontraste equilibrado?</div>
    <div class="rating" data-key="sabor_2">
      <input type="radio" id="sabor_2_1" name="sabor2" value="1"><label for="sabor_2_1">1</label>
      <input type="radio" id="sabor_2_2" name="sabor2" value="2"><label for="sabor_2_2">2</label>
      <input type="radio" id="sabor_2_3" name="sabor2" value="3"><label for="sabor_2_3">3</label>
      <input type="radio" id="sabor_2_4" name="sabor2" value="4"><label for="sabor_2_4">4</label>
      <input type="radio" id="sabor_2_5" name="sabor2" value="5"><label for="sabor_2_5">5</label>
    </div>
    <div class="question">3. ¿Fue memorable?</div>
    <div class="rating" data-key="sabor_3">
      <input type="radio" id="sabor_3_1" name="sabor3" value="1"><label for="sabor_3_1">1</label>
      <input type="radio" id="sabor_3_2" name="sabor3" value="2"><label for="sabor_3_2">2</label>
      <input type="radio" id="sabor_3_3" name="sabor3" value="3"><label for="sabor_3_3">3</label>
      <input type="radio" id="sabor_3_4" name="sabor3" value="4"><label for="sabor_3_4">4</label>
      <input type="radio" id="sabor_3_5" name="sabor3" value="5"><label for="sabor_3_5">5</label>
    </div>
    <div class="question">4. ¿La presentación ayudó al sabor?</div>
    <div class="rating" data-key="sabor_4">
      <input type="radio" id="sabor_4_1" name="sabor4" value="1"><label for="sabor_4_1">1</label>
      <input type="radio" id="sabor_4_2" name="sabor4" value="2"><label for="sabor_4_2">2</label>
      <input type="radio" id="sabor_4_3" name="sabor4" value="3"><label for="sabor_4_3">3</label>
      <input type="radio" id="sabor_4_4" name="sabor4" value="4"><label for="sabor_4_4">4</label>
      <input type="radio" id="sabor_4_5" name="sabor4" value="5"><label for="sabor_4_5">5</label>
    </div>
    <div class="question">5. ¿Lo recomendarías?</div>
    <div class="rating" data-key="sabor_5">
      <input type="radio" id="sabor_5_1" name="sabor5" value="1"><label for="sabor_5_1">1</label>
      <input type="radio" id="sabor_5_2" name="sabor5" value="2"><label for="sabor_5_2">2</label>
      <input type="radio" id="sabor_5_3" name="sabor5" value="3"><label for="sabor_5_3">3</label>
      <input type="radio" id="sabor_5_4" name="sabor5" value="4"><label for="sabor_5_4">4</label>
      <input type="radio" id="sabor_5_5" name="sabor5" value="5"><label for="sabor_5_5">5</label>
    </div>

    <div class="buttons">
      <button id="next1" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Paso 2: Local -->
  <div class="step" data-step="2">
    <h2>Sección 2: Local</h2>
    <!-- Repite misma estructura: preguntas 1–5 con data-key="local_1"... -->
    <div class="question">1. ¿El ambiente te gustó?</div>
    <div class="rating" data-key="local_1">
      <input type="radio" id="local_1_1" name="local1" value="1"><label for="local_1_1">1</label>
      <input type="radio" id="local_1_2" name="local1" value="2"><label for="local_1_2">2</label>
      <input type="radio" id="local_1_3" name="local1" value="3"><label for="local_1_3">3</label>
      <input type="radio" id="local_1_4" name="local1" value="4"><label for="local_1_4">4</label>
      <input type="radio" id="local_1_5" name="local1" value="5"><label for="local_1_5">5</label>
    </div>
    <!-- … hasta local_5 … -->
    <div class="buttons">
      <button id="prev2">Anterior</button>
      <button id="next2" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Paso 3: Atención -->
  <div class="step" data-step="3">
    <h2>Sección 3: Atención</h2>
    <div class="question">1. ¿Fueron amables?</div>
    <div class="rating" data-key="atencion_1">
      <input type="radio" id="atencion_1_1" name="atencion1" value="1"><label for="atencion_1_1">1</label>
      <input type="radio" id="atencion_1_2" name="atencion1" value="2"><label for="atencion_1_2">2</label>
      <input type="radio" id="atencion_1_3" name="atencion1" value="3"><label for="atencion_1_3">3</label>
      <input type="radio" id="atencion_1_4" name="atencion1" value="4"><label for="atencion_1_4">4</label>
      <input type="radio" id="atencion_1_5" name="atencion1" value="5"><label for="atencion_1_5">5</label>
    </div>
    <!-- … hasta atencion_5 … -->
    <div class="buttons">
      <button id="prev3">Anterior</button>
      <button id="next3" disabled>Siguiente</button>
    </div>
  </div>

  <!-- Paso 4: Sugerencias -->
  <div class="step" data-step="4">
    <h2>Sección 4: Sugerencias</h2>
    <textarea id="sugerencias" placeholder="Tu comentario (opcional)"></textarea>
    <div class="buttons">
      <button id="prev4">Anterior</button>
      <button id="submit">Enviar</button>
    </div>
    <p id="message" class="message"></p>
  </div>
</main>

<footer>&copy; 2025 Tango's. ¡Gracias por tu feedback!</footer>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js'

  const supabase = createClient(
    'https://ljlaudvreolkdppgfqul.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqbGF1ZHZyZW9sa2RwcGdmcXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwMzEzOTYsImV4cCI6MjA2MDYwNzM5Nn0.tv5PybOJ0ZUtA2aw2WzPqQ9M7SZm3uke6Ad-OuxZbzk'
  );

  const steps = Array.from(document.querySelectorAll('.step'));
  let current = 0;
  const answers = {};

  // Único envío
  const deviceIdKey = 'encuestaDevice';
  let deviceId = localStorage.getItem(deviceIdKey);
  if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem(deviceIdKey, deviceId);
  }
  // comprueba si ya hay registro
  (async()=>{
    const { data } = await supabase
      .from('encuesta')
      .select('id')
      .eq('device_id', deviceId);
    if (data.length) {
      document.body.innerHTML = `
        <header><h1>Encuesta Tango's</h1></header>
        <main><p class="message">Ya completaste la encuesta. ¡Gracias!</p></main>
        <footer>&copy; 2025 Tango's</footer>`;
    }
  })();

  function showStep(i){
    steps[current].classList.remove('active');
    current = i;
    steps[current].classList.add('active');
  }

  // NEXT/PREV buttons
  document.getElementById('next1').onclick = ()=> showStep(1);
  document.getElementById('prev2').onclick = ()=> showStep(0);
  document.getElementById('next2').onclick = ()=> showStep(2);
  document.getElementById('prev3').onclick = ()=> showStep(1);
  document.getElementById('next3').onclick = ()=> showStep(3);
  document.getElementById('prev4').onclick = ()=> showStep(2);

  // habilita NEXT solo si respondes 5 radios
  steps.slice(0,3).forEach((step, idx)=>{
    step.querySelectorAll('.rating input').forEach(radio=>{
      radio.addEventListener('change', ()=>{
        const radios = step.querySelectorAll('.rating input[name][type=radio]');
        const grouped = {};
        radios.forEach(r=> grouped[r.name] = grouped[r.name]||0, grouped[r.name]++);
        const names = [...new Set(Array.from(radios).map(r=>r.name))];
        const allAnswered = names.every(name=> step.querySelector(`input[name=${name}]:checked`));
        document.getElementById(
          idx===0? 'next1':
          idx===1? 'next2': 'next3'
        ).disabled = !allAnswered;
      });
    });
  });

  // Envío final
  document.getElementById('submit').onclick = async ()=>{
    // recopila
    answers.device_id = deviceId;
    ['sabor','local','atencion'].forEach(sec=>{
      for(let i=1;i<=5;i++){
        answers[`${sec}_${i}`] =
          parseInt(document.querySelector(`input[name=${sec}${i}]:checked`).value);
      }
    });
    answers.sugerencias = document.getElementById('sugerencias').value || null;

    // inserta
    const { error } = await supabase
      .from('encuesta')
      .insert([answers]);

    const msg = document.getElementById('message');
    if (error) {
      msg.textContent = '❌ Error: ' + error.message;
    } else {
      localStorage.setItem('encuestaRespondida', '1');
      msg.textContent = '✅ ¡Encuesta enviada!';
      document.getElementById('submit').disabled = true;
    }
  };
</script>

</body>
</html>
